# -*- sh -*-

not() { "$@" && exit 1 || return 0; }
skip() { exit 200; }

for_dve_small() {
    wrapper=$1; shift
    test "$O_DVE" = "ON" || test "$O_LEGACY" = "ON"|| return 0

    check clear
    run $wrapper data/empty.dve "$@"
    check reachability_any
    $extracheck data/empty.dve

    check clear
    run $wrapper data/test1.dve "$@"
    check ltl_invalid
    check statespace 7 14 3 0
    $extracheck data/test1.dve

    check clear
    run $wrapper data/test2.dve "$@"
    check ltl_valid
    check owcty_sizes 2 2 0
    check statespace 3 2 2 2
    $extracheck data/test2.dve

    check clear
    run $wrapper data/test3.dve "$@"
    check ltl_valid
    check owcty_sizes 2 5 0
    check statespace 6 12 2 0
    $extracheck data/test3.dve

    check clear
    run $wrapper data/test4.dve "$@"
    check ltl_invalid
    check owcty_sizes 1 4 1
    check statespace 5 5 1 0
    $extracheck data/test4.dve

    check clear
    run $wrapper data/test5.dve "$@"
    check ltl_invalid
    check owcty_sizes 1 4 1
    check statespace 5 5 1 0
    $extracheck data/test5.dve

    check clear
    run $wrapper data/test6.dve "$@"
    check ltl_invalid
    check owcty_sizes 2 6 1 5 1
    check statespace 6 6 2 0
    $extracheck data/test6.dve

    check clear
    run $wrapper data/commit1.dve "$@"
    check statespace 10 14 0 0
    $extracheck data/commit1.dve

    check clear
    run $wrapper data/commit2.dve "$@"
    check statespace 8 8 0 2
    $extracheck data/commit2.dve

    check clear
    run $wrapper data/haoEEDM.dve "$@"
    check statespace 502 922 0 0
    $extracheck data/haoEEDM.dve

    check clear
    run $wrapper data/bufchan.dve "$@"
    check statespace 3 5 0 0
    $extracheck data/bufchan.dve

    check clear
    run $wrapper data/bufchan2.dve "$@"
    check statespace 8 12 0 0
    $extracheck data/bufchan2.dve

    check clear
    run $wrapper data/unbufchan.dve "$@"
    check statespace 2 3 0 0
    $extracheck data/unbufchan.dve

    check clear
    run $wrapper data/assert.dve "$@"
    check reachability_goal
    check statespace 6 6 0 0

    check clear
    run $wrapper data/assert2.dve "$@"
    check reachability_valid
    check statespace 6 6 0 0

}

dve_small() {
    for_dve_small identity "$@"
}

dve_compiled_small() {
    test "$O_POOLS" = "ON" || return 0
    for_dve_small dve_compile "$@"
}

llvm_small() {
    test "$O_LLVM" = "ON" || return 0

    check clear
    run llvm_assemble data/global-ok.ll "$@"
    check reachability_valid
    check statespace 46 87 0 0

    check clear
    run llvm_assemble data/global-bug.ll "$@"
    check reachability_goal
    check statespace 26 48 0 0
}

timed_small() {
    wrapper=$1; shift
    test "$O_TIMED" = "ON" || return 0

    check clear
    run $wrapper data/timed_arithm.xml "$@"
    check reachability_valid
    check statespace 46 52 0 0

    check clear
    run $wrapper data/timed_clock.xml "$@"
    check reachability_valid
    check statespace 226 227 0 0

    check clear
    run $wrapper data/bridge.xml --property=0 "$@"
    check ltl_invalid
    check statespace 2882 5157 0 0
    check clear

    run $wrapper data/bridge.xml --property=1 "$@"
    check ltl_valid
    check statespace 3316 5951 399 0
}

coin_small() {
    :
}

all_small() {
    dve_small "$@"
    llvm_small "$@"
    coin_small "$@"
    timed_small "$@"
}

chmod +x check run
PATH=".:$PATH"
extracheck=:
set -vex -o pipefail
trap "check debris" EXIT

